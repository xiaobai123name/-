# 智能学习伴侣系统：完整功能测试指南（按此一步步操作）

本文件用于你在本机 **端到端（E2E）完整跑通** 本项目：登录/注册 → 上传文档 → RAG 问答 → 苏格拉底对话 → 测验练习 → 知识追踪 → 知识图谱 → 设置项。

> 说明：本项目是 Streamlit 多页面应用，入口为 `app/主页.py`，也可以直接运行 `run.ps1` / `run.bat`。

---

## 0. 准备清单（开始前 2 分钟）

### 0.1 必要条件

- Windows 10/11（本指南以 Windows 为主；Linux/Mac 可参考 `README.md` 的命令）
- Python 3.10+（推荐 3.12）
- 一个可用的 **Gemini API Key**（`GOOGLE_API_KEY`），否则无法进行对话/嵌入向量化

### 0.2 你需要准备的测试文档

项目已自带示例文档：`data/sample_docs/transformer_tutorial.md`（推荐用它做首轮测试）。

---

## 1. 从“干净状态”开始（可选，但推荐）

如果你希望每次测试都从零开始（不受历史数据影响），先停止应用，然后执行以下清理。

### 1.1 停止应用

- 关闭运行 Streamlit 的终端窗口，或在终端按 `Ctrl + C`

### 1.2 清理数据（会删除你的历史账号/文档/向量库）

在项目根目录 `d:\my_share\bishe` 打开 PowerShell，执行：

```powershell
Remove-Item -Recurse -Force .\data\uploads\  -ErrorAction SilentlyContinue
Remove-Item -Recurse -Force .\data\chroma_db\ -ErrorAction SilentlyContinue
Remove-Item -Force .\data\learning_companion.db -ErrorAction SilentlyContinue
```

预期结果：
- `data/learning_companion.db` 不存在
- `data/chroma_db/` 和 `data/uploads/` 被清空/删除（后续运行会自动创建）

---

## 2. 配置 `.env`（必做）

### 2.1 创建 `.env`

如果根目录下没有 `.env`，先复制模板：

```powershell
Copy-Item .\.env.example .\.env
```

### 2.2 编辑 `.env`（必须为 UTF-8 编码）

至少填写这一项：

```env
GOOGLE_API_KEY=你的真实key
```

可选项（不填也能跑，但部分功能会降级/关闭）：

```env
LLAMA_CLOUD_API_KEY=你的llamaparse_key
SILICONFLOW_API_KEY=你的siliconflow_key
```

预期结果：
- 启动后在“设置”页能看到 Gemini 状态为“已配置”

---

## 3. 安装依赖并启动

### 3.1 推荐启动方式（Windows）

优先用脚本启动（会自动激活虚拟环境，并在没有 `.env` 时从模板创建）：

- PowerShell：运行 `run.ps1`
- CMD：运行 `run.bat`

如果你本地没有 `venv/`（或想重建虚拟环境），先执行：

```powershell
python -m venv venv
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt
```

例如 PowerShell：

```powershell
.\run.ps1
```

如果你不想用脚本，也可以手动启动：

```powershell
.\venv\Scripts\Activate.ps1
pip install -r requirements.txt
streamlit run app/主页.py
```

### 3.2 打开网页

浏览器访问：`http://localhost:8501`

预期结果：
- 页面显示“智能学习伴侣”主页（若未登录会显示登录/注册页）
- 终端无明显报错（少量 Streamlit 警告可忽略）

---

## 4. 功能测试 1：注册、登录、退出

1. 打开首页 → 切到“注册”Tab
2. 注册一个新账号（用户名/密码随意，但记住）
3. 回到“登录”Tab → 登录
4. 登录后在左侧栏点击“退出登录”
5. 再次登录

预期结果：
- 注册成功后可登录
- 退出登录后回到登录/注册页
- 登录后进入“仪表盘”（展示文档数、答题数等指标）

---

## 5. 功能测试 2：文档上传、解析、向量化、删除

1. 从首页进入 `文档管理`（页面：`pages/2_文档管理.py`）
2. 上传示例文档：`data/sample_docs/transformer_tutorial.md`
3. 等待进度条走完（首次会进行向量化，可能需要几十秒到数分钟，取决于网络与 API 响应）
4. 在文档列表中确认该文档状态为“已完成”，并显示“片段数（chunk_count）”
5. 点击“删除”，确认文档能被移除

预期结果：
- 上传后文档状态最终为 `completed`
- `data/uploads/<你的用户id>/` 下存在已上传文件
- `data/chroma_db/` 下生成 Chroma 持久化文件
- 删除后：文档从列表消失；问答/测验不会再检索到该文档内容

失败排查（常见）：
- 若“处理失败：…GOOGLE_API_KEY…”：说明 `.env` 没配置或编码不对；修好后重启应用再试
- 若 PDF 解析效果差：不配 `LLAMA_CLOUD_API_KEY` 时会走基础解析（属于正常降级）

---

## 6. 功能测试 3：智能问答（RAG + 引用）

前置：至少有 1 篇文档处于“已完成”状态。

1. 进入 `智能问答`（页面：`pages/1_智能问答.py`）
2. 侧边栏 `文档范围`：先选择你刚上传的文档（便于验证）
3. 提问（示例，可根据文档内容调整）：
   - “这份材料主要讲了什么？请给出要点。”
   - “请解释 transformer 的 self-attention，并给出文档依据。”
4. 查看回答下方的“参考来源”，展开查看原文片段
5. 点击“新建对话”，再问一次不同问题
6. 在侧边栏历史对话中切换，确认能加载历史消息

预期结果：
- 回答内容与文档相关
- 显示引用来源（文件名/页码可能因格式而不同；Markdown 通常无页码）
- 历史对话可回放

---

## 7. 功能测试 4：苏格拉底对话 + 学习总结

1. 在 `智能问答` 页侧边栏，将模式切到“苏格拉底对话”
2. 提一个你希望被“引导式理解”的问题（示例）：
   - “为什么 attention 能取代 RNN 的部分能力？”
3. 连续对话至少 4 轮
4. 点击侧边栏“生成学习总结”

预期结果：
- 系统会更多以“提问/引导”为主，而非直接给结论
- 点击总结后生成一段学习总结文本

---

## 8. 功能测试 5：测验练习、错题追问、知识追踪

前置：至少有 1 篇文档处于“已完成”状态。

### 8.1 综合复习（按文档出题）

1. 进入 `测验练习`（页面：`pages/3_测验练习.py`）
2. 在“综合复习”Tab：
   - 选择 1 篇文档
   - 题目数量选 5
   - 题型选“混合题型”
   - 难度选“中等”
3. 点击“生成测验”
4. 故意做错 1~2 题，再做对其余题（用于验证错题与追踪）
5. 提交后查看：
   - 正误判定
   - 解析（explanation）
   - 错题是否出现“追问/引导”（如页面提示）

预期结果：
- 能生成题目并可作答
- 会记录答题结果，统计正确率/累计答题数

### 8.2 专项突破（按知识点出题）

1. 仍在 `测验练习` 页，先在侧边栏的“智能专项选择器”里勾选 1~2 个知识点
2. 切到“专项突破”Tab → 点击“开始专项特训”

预期结果：
- 题目围绕你选的知识点生成（跨文档检索）
- 做错后该知识点在侧边栏统计里会更“显眼”（错题数/薄弱点）

### 8.3 回到主页验证“知识追踪”

1. 回到 `主页`（仪表盘）
2. 查看指标是否更新：
   - “累计答题”“正确率”
   - “待复习错题”
3. 右侧“智能建议”是否会根据错题给出“专项特训”入口

---

## 9. 功能测试 6：知识图谱构建与可视化

前置：至少有 1 篇文档处于“已完成”状态；`requirements.txt` 已安装 `streamlit-agraph`。

1. 进入 `知识图谱`（页面：`pages/4_知识图谱.py`）
2. 侧边栏选择“单文档”或“全部文档”
3. 点击“构建知识图谱”
4. 在左侧搜索一个实体关键词（例如 transformer / attention / 神经网络等）
5. 点击搜索结果，观察图谱中节点/关系变化

预期结果：
- 构建完成提示“实体数/关系数”
- 页面显示可交互图谱（节点、边）
- 搜索能定位实体

失败排查（常见）：
- 若提示缺少 agraph 组件：重新 `pip install -r requirements.txt` 并重启
- 若构建很慢：属于 LLM 抽取过程；可先用“单文档”测试

---

## 10. 功能测试 7：设置页（API 状态 / 修改密码 / 模型偏好）

1. 进入 `设置`（页面：`pages/5_设置.py`）
2. 查看 API 状态：
   - Gemini：应为“已配置”
   - LlamaParse / 硅基流动：未配则显示“未配置（降级）”
3. “修改密码”：输入旧密码 → 设置新密码 → 退出登录 → 用新密码登录
4. “模型选择（按模块）”：尝试对 `智能问答（RAG）` 修改 provider/model 并保存（如你有对应 key）

预期结果：
- 密码修改成功后旧密码不可再登录
- 模型偏好保存后对话行为会按设置变化（需要对应 API Key）

---

## 11. 最终验收（你可以用这一段确认“完整跑通”）

满足以下条件即可认为项目核心功能已完整通过：

- 能注册/登录/退出/改密
- 能上传并处理至少 1 篇文档（状态 completed）
- 智能问答能基于文档回答，并展示引用
- 苏格拉底对话能多轮引导并生成总结
- 测验能生成、提交、统计；错题能进入“待复习/薄弱点”逻辑
- 知识图谱能构建并展示基本可视化

---

## 12. 常见问题（快速定位）

### 12.1 启动后页面空白/报错

- 先看启动终端输出（Streamlit 会打印堆栈）
- 常见原因：`.env` 没读到（编码不对/未填写 `GOOGLE_API_KEY`）
- 修复后请 **完全重启**：结束进程，再重新 `streamlit run app/主页.py`

### 12.2 “已上传但问答检索不到”

- 确认文档在 `文档管理` 页状态为“已完成”
- 确认 `data/chroma_db/` 目录内有文件生成
- 侧边栏 `文档范围` 若只选了其他文档，会导致搜不到

### 12.3 端口被占用（8501）

改用其他端口启动：

```powershell
streamlit run app/主页.py --server.port 8502
```
